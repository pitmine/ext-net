OpenStack external ("DMZ") network module
=========================================

This very basic Terraform module for OpenStack creates a network and subnet
connected to an external ("public") network gateway via a router.
Both the UUID of an **external_gateway** network
and a **subnet** CIDR range must be provided as input variables
(OpenStack **region** and base **name** prefix can optionally be provided).

A network UUID output attribute **uuid** is generated by the module.

Another output attribute is a floating IP **pool** name,
which can optionally be passed as an input variable as well,
but this is a workaround for Terraform 0.4.2's inability to declare
explicit dependencies on modules,
and should be defaulted whenever possible.
Floating IP resources do need to use this output to create the dependency,
which is necessary to ensure proper ordering of destroy operations
(see *Example Usage* and *Attribute Reference* below for more details).

Example Usage
-------------

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
provider "openstack" {
    auth_url = "${var.auth_url}"
    tenant_name = "ext-net-example"
}

module "dmz" {
    source = "github.com/pitmine/ext-net"
    external_gateway = "ca80ff29-4f29-49a5-aa22-549f31b09268"
    subnet = "10.0.2.0/24"
}

resource "openstack_compute_floatingip_v2" "public_ip" {
    region = ""
    pool = "${module.dmz.pool}"

    # explicit dependency on module is not yet supported
    # depends_on = ["module.dmz"]
}

resource "openstack_compute_instance_v2" "server" {
    region = ""
    name = "server"
    image_name = "Ubuntu 14.04 LTS"
    flavor_name = "m1.small"
    floating_ip = "${openstack_compute_floatingip_v2.public_ip.address}"
    network {
        uuid = "${module.dmz.uuid}"
    }
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Argument Reference
------------------

The following module inputs (arguments) are supported:

-   `subnet` - (Required) Subnet CIDR address range

    This is the range of *internal* IP addresses for the network,
    unrelated to any external (public) floating IP address pool.

-   `external_gateway` - (Required) Network UUID of external network

-   `pool` - (Optional; default is "public") Name of IP address pool

    This is used for floating IP allocations
    and should be the one for the external gateway network given above
    (see **pool** in *Attributes Reference* below)

-   `region` - (Optional; default is empty string = OpenStack default region)
    OpenStack region (e.g. `$OS_REGION_NAME` on OpenStack RC file)

-   `name` - (Optional; default is "ext-net") Base name for network resources

    If this is defaulted the following OpenStack names (*not* Terraform names)
    are used for created resources:

    -   network "ext-net"
    -   subnet "ext-net-subnet"
    -   router "ext-net-gateway"

Attributes Reference
--------------------

The following module outputs (attributes) are exported:

-   `uuid` - Network UUID for use in OpenStack Nova compute instances

-   `pool` - Name of IP address pool for floating IP allocations

    This should be associated with the external gateway network given above.

    To insure the proper destruction order
    (compute instance -> floating IP -> gateway router)
    floating IPs should have a dependency on the gateway router.

    Terraform 0.4.2 does not allow **depends_on** to use a module name
    (see <https://github.com/hashicorp/terraform/issues/1178>)
    or to contain an interpolated variable,
    so there is no way to create an explicit dependency.
    Instead we create an implicit dependency by having the floating IP
    get the pool name from this module.

    Note that Terraform 0.4-0.4.2 have other problems with module dependencies
    as well (see <https://github.com/hashicorp/terraform/issues/1582>)
    so resource destruction using modules will require manual intervention.
